# 🏗️ Архитектура системы защиты

## Схема работы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Пользователь  │───▶│  pohorony-minsk  │───▶│  Прокси-сервер  │
│                 │    │      .by         │    │  81.177.222.35  │
└─────────────────┘    │   (ваш домен)    │    └─────────────────┘
                       └──────────────────┘             │
                                                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │   Тильда (IP)    │◀───│  Bot Protection │
                       │  45.155.60.8     │    │   + Redirects   │
                       │ (pohory-minsk)   │    └─────────────────┘
                       └──────────────────┘
```

## 🔄 Процесс защиты

### 1. Первый визит (Новый IP)
```
Пользователь → pohorony-minsk.by → Прокси → 45.155.60.8
                    ↓
            IP записывается в БД
```

### 2. Повторный визит (в течение 4 часов)
```
Пользователь → pohorony-minsk.by → Прокси → 45.155.60.8
                    ↓
            Счетчик посещений +1
```

### 3. После 4 часов (Блокировка)
```
Бот → pohorony-minsk.by → Прокси → Бесконечные редиректы
                    ↓
            /redirect-1 → /redirect-2 → /redirect-3...
```

## 📊 Компоненты системы

### 1. DNS настройка
- **Домен**: `pohorony-minsk.by`
- **A-запись**: `IP адрес вашего VPS`
- **TTL**: 300 секунд

### 2. VPS/Сервер
- **Прокси-сервер**: Node.js + Express
- **База данных**: PostgreSQL
- **Веб-сервер**: Nginx (опционально)
- **SSL**: Let's Encrypt

### 3. База данных
```sql
ip_tracking:
- ip_address (INET)
- first_visit (TIMESTAMP)
- visit_count (INTEGER)
- is_banned (BOOLEAN)
- banned_at (TIMESTAMP)

redirect_chains: НЕ ИСПОЛЬЗУЕТСЯ
- Редиректы логируются только в консоль
- Не хранятся в базе данных для экономии ресурсов
```

### 4. Логика защиты
- **Отслеживание**: Каждый IP записывается при первом визите
- **Таймер**: 4 часа с момента первого визита
- **Блокировка**: Автоматическая через 4 часа
- **Редиректы**: Бесконечный цикл для заблокированных IP

## 🚀 Варианты развертывания

### Вариант 1: VPS (Рекомендуется)
- **Провайдер**: DigitalOcean, Vultr, AWS, Yandex Cloud
- **Конфигурация**: 2 CPU, 2GB RAM, 20GB SSD
- **Стоимость**: ~$10-20/месяц
- **Управление**: Полный контроль

### Вариант 2: Облако
- **AWS**: EC2 + RDS
- **Google Cloud**: Compute Engine + Cloud SQL
- **Yandex Cloud**: Compute Cloud + Managed PostgreSQL
- **Преимущества**: Автомасштабирование, мониторинг

### Вариант 3: Shared Hosting
- **Ограничения**: Может не поддерживать Docker
- **Альтернатива**: Прямая установка Node.js
- **Требования**: Поддержка PostgreSQL

## 🔧 Настройка DNS

### В панели управления доменом:
```
Тип записи: A
Имя: @ (или pohorony-minsk)
Значение: 81.177.222.35
TTL: 300
```

### Дополнительные записи:
```
Тип: CNAME
Имя: www
Значение: pohorony-minsk.by
```

## 📈 Мониторинг

### Ключевые метрики:
- Количество заблокированных IP
- Время отклика прокси
- Использование ресурсов

### Логи для анализа:
- Новые IP адреса
- Заблокированные IP
- Редиректы (в консоли)
- Ошибки системы

## 🛡️ Безопасность

### Защита сервера:
- Firewall (только порты 80, 443, 22)
- SSH ключи вместо паролей
- Регулярные обновления
- Мониторинг логов

### Защита приложения:
- Rate limiting
- Helmet.js для заголовков
- Валидация входных данных
- Логирование подозрительной активности
